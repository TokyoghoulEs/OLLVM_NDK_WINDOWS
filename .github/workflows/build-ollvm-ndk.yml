# ============================================================================
# OLLVM Clang Builder for Windows
# ============================================================================
# Compila SOLO los binarios de Clang con OLLVM (no el NDK completo)
# Los binarios se suben al repositorio en la rama 'binaries'
# 
# Tama√±o estimado: ~150-200MB (en lugar de 1.5GB del NDK completo)
# Tiempo: 2-3 horas
# ============================================================================

name: Build OLLVM Clang for Windows

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM Version'
        required: true
        default: '17.0.6'
        type: choice
        options:
          - '17.0.6'
          - '18.1.8'
      build_type:
        description: 'Build Type'
        required: true
        default: 'MinSizeRel'
        type: choice
        options:
          - MinSizeRel
          - Release

env:
  LLVM_VERSION: ${{ github.event.inputs.llvm_version || '17.0.6' }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'MinSizeRel' }}

jobs:
  build-ollvm:
    name: Build OLLVM ${{ github.event.inputs.llvm_version }}
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    # ========================================================================
    # PREPARACI√ìN
    # ========================================================================
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Ninja
      run: choco install ninja -y
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Free disk space
      run: |
        # Liberar espacio eliminando cosas innecesarias
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.9*" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.10*" -ErrorAction SilentlyContinue

    # ========================================================================
    # DESCARGAR LLVM Y OLLVM
    # ========================================================================
    - name: Clone LLVM Project
      run: |
        Write-Host "üì• Clonando LLVM $env:LLVM_VERSION..."
        git clone --depth 1 --branch "llvmorg-$env:LLVM_VERSION" https://github.com/llvm/llvm-project.git
        
    - name: Download OLLVM Passes
      run: |
        Write-Host "üì• Descargando OLLVM passes..."
        git clone https://github.com/DreamSoule/ollvm17.git ollvm-passes
        Copy-Item -Recurse "ollvm-passes/Obfuscation" "llvm-project/llvm/lib/Obfuscation"
        
        # Parchear CMakeLists.txt
        Add-Content -Path "llvm-project/llvm/lib/CMakeLists.txt" -Value "`nadd_subdirectory(Obfuscation)"
        
        Write-Host "‚úÖ OLLVM configurado"

    # ========================================================================
    # COMPILAR
    # ========================================================================
    - name: Configure CMake
      run: |
        cmake -S llvm-project/llvm -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DLLVM_ENABLE_PROJECTS="clang;lld" `
          -DLLVM_TARGETS_TO_BUILD="AArch64;ARM" `
          -DLLVM_ENABLE_ASSERTIONS=OFF `
          -DLLVM_ENABLE_BACKTRACES=OFF `
          -DLLVM_ENABLE_WARNINGS=OFF `
          -DLLVM_INCLUDE_TESTS=OFF `
          -DLLVM_INCLUDE_EXAMPLES=OFF `
          -DLLVM_INCLUDE_BENCHMARKS=OFF `
          -DLLVM_INCLUDE_DOCS=OFF `
          -DLLVM_OBFUSCATION_LINK_INTO_TOOLS=ON `
          -DCMAKE_C_COMPILER=cl `
          -DCMAKE_CXX_COMPILER=cl

    - name: Build LLVM with OLLVM
      run: |
        Write-Host "üî® Compilando (2-3 horas)..."
        cmake --build build --config $env:BUILD_TYPE --target clang lld llvm-ar llvm-strip -j 2

    # ========================================================================
    # PREPARAR BINARIOS
    # ========================================================================
    - name: Prepare binaries
      run: |
        Write-Host "üì¶ Preparando binarios..."
        
        New-Item -ItemType Directory -Path "ollvm-binaries" -Force
        
        # Copiar binarios esenciales
        $binaries = @(
          "clang.exe",
          "clang++.exe",
          "clang-cl.exe",
          "lld.exe",
          "lld-link.exe",
          "ld.lld.exe",
          "llvm-ar.exe",
          "llvm-strip.exe"
        )
        
        foreach ($bin in $binaries) {
          $src = "build/bin/$bin"
          if (Test-Path $src) {
            Copy-Item $src "ollvm-binaries/"
            Write-Host "  ‚úÖ $bin"
          }
        }
        
        # Crear README
        @"
# OLLVM Binaries for Windows

## Info
- LLVM Version: $env:LLVM_VERSION
- Build Type: $env:BUILD_TYPE
- Build Date: $(Get-Date -Format "yyyy-MM-dd")

## Binarios incluidos
- clang.exe / clang++.exe - Compiladores C/C++ con OLLVM
- lld.exe / lld-link.exe - Linker
- llvm-ar.exe - Archiver
- llvm-strip.exe - Strip symbols

## Flags de OLLVM
- -mllvm -fla : Control Flow Flattening
- -mllvm -bcf : Bogus Control Flow  
- -mllvm -sub : Instruction Substitution
- -mllvm -sobf : String Obfuscation
- -mllvm -split : Basic Block Split
- -mllvm -ibr : Indirect Branch
- -mllvm -icall : Indirect Call

## Integrar en NDK

1. Descargar NDK oficial de Google
2. Ir a: ndk/toolchains/llvm/prebuilt/windows-x86_64/bin/
3. Hacer backup de clang.exe y clang++.exe originales
4. Copiar estos binarios ah√≠
5. Listo!

## Ejemplo de uso

clang.exe -target aarch64-linux-android21 -mllvm -fla -mllvm -bcf -c test.c -o test.o
"@ | Out-File -FilePath "ollvm-binaries/README.md" -Encoding UTF8

        # Mostrar tama√±o
        $size = (Get-ChildItem "ollvm-binaries" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "üìä Tama√±o total: $([math]::Round($size, 2)) MB"

    # ========================================================================
    # VERIFICAR QUE FUNCIONA
    # ========================================================================
    - name: Test OLLVM
      run: |
        Write-Host "üß™ Probando OLLVM..."
        
        @"
        int test(int x) {
            if (x > 10) return x * 2;
            else return x + 1;
        }
"@ | Out-File -FilePath "test.c" -Encoding UTF8
        
        # Probar compilaci√≥n con flags de OLLVM
        & "ollvm-binaries/clang.exe" -target aarch64-linux-android21 -mllvm -fla -c test.c -o test.o
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "‚úÖ OLLVM funciona correctamente!"
        } else {
          Write-Host "‚ùå Error en OLLVM"
          exit 1
        }

    # ========================================================================
    # COMPRIMIR Y SUBIR
    # ========================================================================
    - name: Create ZIP
      run: |
        $zipName = "OLLVM-$env:LLVM_VERSION-Windows-x64.zip"
        Compress-Archive -Path "ollvm-binaries/*" -DestinationPath $zipName
        
        $size = (Get-Item $zipName).Length / 1MB
        Write-Host "üì¶ $zipName - $([math]::Round($size, 2)) MB"

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ollvm-${{ env.LLVM_VERSION }}
        name: OLLVM ${{ env.LLVM_VERSION }} for Windows
        body: |
          ## OLLVM Clang Binaries for Windows
          
          - **LLVM**: ${{ env.LLVM_VERSION }}
          - **Build**: ${{ env.BUILD_TYPE }}
          - **Target**: AArch64, ARM (Android)
          
          ### Flags disponibles
          ```
          -mllvm -fla    # Control Flow Flattening
          -mllvm -bcf    # Bogus Control Flow
          -mllvm -sub    # Instruction Substitution
          -mllvm -sobf   # String Obfuscation
          -mllvm -split  # Basic Block Split
          -mllvm -ibr    # Indirect Branch
          -mllvm -icall  # Indirect Call
          ```
          
          ### Instalaci√≥n
          1. Descargar el ZIP
          2. Extraer en `NDK/toolchains/llvm/prebuilt/windows-x86_64/bin/`
          3. Reemplazar clang.exe y clang++.exe
        files: OLLVM-*.zip
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ========================================================================
    # COMMIT AL REPO (rama binaries)
    # ========================================================================
    - name: Commit binaries to repo
      run: |
        Write-Host "üì§ Subiendo binarios al repositorio..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Crear rama binaries si no existe
        git checkout -B binaries
        
        # Limpiar y copiar binarios
        Remove-Item -Recurse -Force * -Exclude ".git" -ErrorAction SilentlyContinue
        Copy-Item -Recurse "ollvm-binaries/*" .
        
        # Commit
        git add -A
        git commit -m "OLLVM $env:LLVM_VERSION binaries - $(Get-Date -Format 'yyyy-MM-dd')"
        git push -f origin binaries
        
        Write-Host "‚úÖ Binarios subidos a rama 'binaries'"
