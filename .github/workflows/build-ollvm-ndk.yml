name: Build OLLVM Clang for Windows

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: LLVM Version
        required: true
        default: '17.0.6'
        type: choice
        options:
          - '17.0.6'
          - '18.1.8'
      build_type:
        description: Build Type
        required: true
        default: MinSizeRel
        type: choice
        options:
          - MinSizeRel
          - Release

env:
  LLVM_VERSION: ${{ github.event.inputs.llvm_version || '17.0.6' }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'MinSizeRel' }}

jobs:
  build-ollvm:
    name: Build OLLVM ${{ github.event.inputs.llvm_version }}
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Ninja
      run: choco install ninja -y

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Free disk space
      run: |
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.9*" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.10*" -ErrorAction SilentlyContinue

    - name: Clone LLVM Project
      run: |
        Write-Host "Clonando LLVM $env:LLVM_VERSION..."
        git clone --depth 1 --branch "llvmorg-$env:LLVM_VERSION" https://github.com/llvm/llvm-project.git

    - name: Download OLLVM Passes
      run: |
        Write-Host "Descargando OLLVM passes desde DreamSoule/ollvm17..."
        git clone --depth 1 https://github.com/DreamSoule/ollvm17.git ollvm-source
        
        Write-Host "Copiando passes de ofuscacion..."
        # La estructura correcta en DreamSoule/ollvm17 es: llvm-project/llvm/lib/Passes/Obfuscation/
        Copy-Item -Recurse "ollvm-source/llvm-project/llvm/lib/Passes/Obfuscation" "llvm-project/llvm/lib/Passes/"
        
        Write-Host "Copiando PassBuilder.cpp modificado..."
        Copy-Item -Force "ollvm-source/llvm-project/llvm/lib/Passes/PassBuilder.cpp" "llvm-project/llvm/lib/Passes/"
        
        Write-Host "Copiando CMakeLists.txt modificado..."
        Copy-Item -Force "ollvm-source/llvm-project/llvm/lib/Passes/CMakeLists.txt" "llvm-project/llvm/lib/Passes/"
        
        Write-Host "Verificando archivos copiados..."
        Get-ChildItem "llvm-project/llvm/lib/Passes/Obfuscation" | ForEach-Object { Write-Host "  - $($_.Name)" }
        
        Write-Host "OLLVM configurado correctamente"

    - name: Configure CMake
      run: |
        cmake -S llvm-project/llvm -B build -G Ninja `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DLLVM_ENABLE_PROJECTS="clang;lld" `
          -DLLVM_TARGETS_TO_BUILD="AArch64;ARM" `
          -DLLVM_ENABLE_ASSERTIONS=OFF `
          -DLLVM_ENABLE_BACKTRACES=OFF `
          -DLLVM_ENABLE_WARNINGS=OFF `
          -DLLVM_INCLUDE_TESTS=OFF `
          -DLLVM_INCLUDE_EXAMPLES=OFF `
          -DLLVM_INCLUDE_BENCHMARKS=OFF `
          -DLLVM_INCLUDE_DOCS=OFF `
          -DCMAKE_C_COMPILER=cl `
          -DCMAKE_CXX_COMPILER=cl

    - name: Build LLVM with OLLVM
      run: |
        Write-Host "Compilando LLVM con OLLVM (2-3 horas)..."
        cmake --build build --config $env:BUILD_TYPE --target clang lld llvm-ar llvm-strip -j 2

    - name: Prepare binaries
      run: |
        Write-Host "Preparando binarios..."
        New-Item -ItemType Directory -Path "ollvm-binaries" -Force
        $binaries = @(
          "clang.exe", 
          "clang++.exe", 
          "clang-cl.exe", 
          "lld.exe", 
          "lld-link.exe", 
          "ld.lld.exe", 
          "llvm-ar.exe", 
          "llvm-strip.exe"
        )
        foreach ($bin in $binaries) {
          $src = "build/bin/$bin"
          if (Test-Path $src) {
            Copy-Item $src "ollvm-binaries/"
            Write-Host "Copiado: $bin"
          } else {
            Write-Host "No encontrado: $bin"
          }
        }
        
        # Crear README
        $readmeContent = @"
# OLLVM Binaries

LLVM Version: $env:LLVM_VERSION
Build Type: $env:BUILD_TYPE
Target: AArch64, ARM (Android)

Flags: -mllvm -fla, -mllvm -bcf, -mllvm -sub, -mllvm -sobf, -mllvm -split

Uso: clang -target aarch64-linux-android21 -mllvm -fla -mllvm -bcf -c archivo.c

Creditos: DreamSoule/ollvm17, TokyoghoulEs
"@
        $readmeContent | Out-File -FilePath "ollvm-binaries/README.md" -Encoding UTF8

        $size = (Get-ChildItem "ollvm-binaries" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "Tamano total: $([math]::Round($size, 2)) MB"

    - name: Test OLLVM
      run: |
        Write-Host "Probando OLLVM..."
        @"
int test(int x) {
    if (x > 10) return x * 2;
    if (x < 5) return x - 1;
    return x + 1;
}
"@ | Out-File -FilePath "test.c" -Encoding UTF8

        & "ollvm-binaries/clang.exe" -target aarch64-linux-android21 -mllvm -fla -c test.c -o test.o
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Test 1 (FLA): OK"
        } else {
          Write-Host "Test 1 (FLA): FAILED"
          exit 1
        }
        
        & "ollvm-binaries/clang.exe" -target aarch64-linux-android21 -mllvm -bcf -c test.c -o test2.o
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Test 2 (BCF): OK"
        } else {
          Write-Host "Test 2 (BCF): FAILED"
          exit 1
        }
        
        Write-Host "Todos los tests pasaron!"

    - name: Create ZIP
      run: |
        $zipName = "OLLVM-$env:LLVM_VERSION-Windows-x64.zip"
        Compress-Archive -Path "ollvm-binaries/*" -DestinationPath $zipName
        $size = (Get-Item $zipName).Length / 1MB
        Write-Host "ZIP creado: $zipName - $([math]::Round($size, 2)) MB"

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ollvm-${{ env.LLVM_VERSION }}
        name: OLLVM ${{ env.LLVM_VERSION }} for Windows
        body: |
          ## OLLVM Clang Binaries for Windows
          
          **LLVM Version:** ${{ env.LLVM_VERSION }}
          **Build Type:** ${{ env.BUILD_TYPE }}
          **Target Architectures:** AArch64, ARM (Android)
          
          ### Flags de Ofuscacion
          
          | Flag | Descripcion |
          |------|-------------|
          | `-mllvm -fla` | Control Flow Flattening |
          | `-mllvm -bcf` | Bogus Control Flow |
          | `-mllvm -sub` | Instruction Substitution |
          | `-mllvm -sobf` | String Obfuscation |
          | `-mllvm -split` | Basic Block Split |
          | `-mllvm -ibr` | Indirect Branch |
          | `-mllvm -icall` | Indirect Call |
          
          ### Instalacion
          
          1. Descarga el ZIP
          2. Extrae los binarios
          3. Copia a `NDK/toolchains/llvm/prebuilt/windows-x86_64/bin/`
          4. Usa con: `clang -mllvm -fla -mllvm -bcf ...`
          
          ### Creditos
          - OLLVM: DreamSoule/ollvm17
          - Builder: TokyoghoulEs
        files: OLLVM-*.zip
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit binaries to repo
      run: |
        Write-Host "Subiendo binarios al repositorio..."
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -B binaries
        Get-ChildItem -Exclude ".git","ollvm-binaries" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "ollvm-binaries/*" . -Force
        git add -A
        git commit -m "OLLVM $env:LLVM_VERSION binaries - $(Get-Date -Format 'yyyy-MM-dd')"
        git push -f origin binaries
        Write-Host "Binarios subidos a rama 'binaries'"
