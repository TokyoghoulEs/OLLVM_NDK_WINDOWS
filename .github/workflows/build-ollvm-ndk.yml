name: Build OLLVM Clang for Windows

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: LLVM Version
        required: true
        default: '17.0.6'
        type: choice
        options:
          - '17.0.6'
          - '18.1.8'
      build_type:
        description: Build Type
        required: true
        default: MinSizeRel
        type: choice
        options:
          - MinSizeRel
          - Release

env:
  LLVM_VERSION: ${{ github.event.inputs.llvm_version || '17.0.6' }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'MinSizeRel' }}

jobs:
  build-ollvm:
    name: Build OLLVM ${{ github.event.inputs.llvm_version }}
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Ninja
      run: choco install ninja -y
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Free disk space
      run: |
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.9*" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.10*" -ErrorAction SilentlyContinue

    - name: Clone LLVM Project
      run: |
        Write-Host "Clonando LLVM $env:LLVM_VERSION..."
        git clone --depth 1 --branch "llvmorg-$env:LLVM_VERSION" https://github.com/llvm/llvm-project.git
        
    - name: Download OLLVM Passes
      run: |
        Write-Host "Descargando OLLVM passes..."
        git clone https://github.com/DreamSoule/ollvm17.git ollvm-passes
        Copy-Item -Recurse "ollvm-passes/Obfuscation" "llvm-project/llvm/lib/Obfuscation"
        Add-Content -Path "llvm-project/llvm/lib/CMakeLists.txt" -Value "`nadd_subdirectory(Obfuscation)"
        Write-Host "OLLVM configurado"

    - name: Configure CMake
      run: |
        cmake -S llvm-project/llvm -B build -G Ninja -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE -DLLVM_ENABLE_PROJECTS="clang;lld" -DLLVM_TARGETS_TO_BUILD="AArch64;ARM" -DLLVM_ENABLE_ASSERTIONS=OFF -DLLVM_ENABLE_BACKTRACES=OFF -DLLVM_ENABLE_WARNINGS=OFF -DLLVM_INCLUDE_TESTS=OFF -DLLVM_INCLUDE_EXAMPLES=OFF -DLLVM_INCLUDE_BENCHMARKS=OFF -DLLVM_INCLUDE_DOCS=OFF -DLLVM_OBFUSCATION_LINK_INTO_TOOLS=ON -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl

    - name: Build LLVM with OLLVM
      run: |
        Write-Host "Compilando LLVM con OLLVM (2-3 horas)..."
        cmake --build build --config $env:BUILD_TYPE --target clang lld llvm-ar llvm-strip -j 2

    - name: Prepare binaries
      run: |
        Write-Host "Preparando binarios..."
        New-Item -ItemType Directory -Path "ollvm-binaries" -Force
        $binaries = @("clang.exe", "clang++.exe", "clang-cl.exe", "lld.exe", "lld-link.exe", "ld.lld.exe", "llvm-ar.exe", "llvm-strip.exe")
        foreach ($bin in $binaries) {
          $src = "build/bin/$bin"
          if (Test-Path $src) {
            Copy-Item $src "ollvm-binaries/"
            Write-Host "Copiado: $bin"
          }
        }
        $readme = "# OLLVM Binaries`n`nLLVM: $env:LLVM_VERSION`nBuild: $env:BUILD_TYPE`n`nFlags: -mllvm -fla, -mllvm -bcf, -mllvm -sub, -mllvm -sobf"
        $readme | Out-File -FilePath "ollvm-binaries/README.md" -Encoding UTF8
        $size = (Get-ChildItem "ollvm-binaries" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "Tamano total: $([math]::Round($size, 2)) MB"

    - name: Test OLLVM
      run: |
        Write-Host "Probando OLLVM..."
        "int test(int x) { if (x > 10) return x * 2; return x + 1; }" | Out-File -FilePath "test.c" -Encoding UTF8
        & "ollvm-binaries/clang.exe" -target aarch64-linux-android21 -mllvm -fla -c test.c -o test.o
        if ($LASTEXITCODE -eq 0) {
          Write-Host "OLLVM funciona correctamente!"
        } else {
          Write-Host "Error en OLLVM"
          exit 1
        }

    - name: Create ZIP
      run: |
        $zipName = "OLLVM-$env:LLVM_VERSION-Windows-x64.zip"
        Compress-Archive -Path "ollvm-binaries/*" -DestinationPath $zipName
        $size = (Get-Item $zipName).Length / 1MB
        Write-Host "ZIP creado: $zipName - $([math]::Round($size, 2)) MB"

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ollvm-${{ env.LLVM_VERSION }}
        name: OLLVM ${{ env.LLVM_VERSION }} for Windows
        body: |
          OLLVM Clang Binaries for Windows
          
          LLVM: ${{ env.LLVM_VERSION }}
          Build: ${{ env.BUILD_TYPE }}
          Target: AArch64, ARM (Android)
          
          Flags disponibles:
          -mllvm -fla (Control Flow Flattening)
          -mllvm -bcf (Bogus Control Flow)
          -mllvm -sub (Instruction Substitution)
          -mllvm -sobf (String Obfuscation)
          -mllvm -split (Basic Block Split)
          -mllvm -ibr (Indirect Branch)
          -mllvm -icall (Indirect Call)
        files: OLLVM-*.zip
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit binaries to repo
      run: |
        Write-Host "Subiendo binarios al repositorio..."
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -B binaries
        Get-ChildItem -Exclude ".git","ollvm-binaries" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "ollvm-binaries/*" . -Force
        git add -A
        git commit -m "OLLVM $env:LLVM_VERSION binaries"
        git push -f origin binaries
        Write-Host "Binarios subidos a rama binaries"
