name: Build OLLVM Clang for Windows

on:
  workflow_dispatch:
    inputs:
      llvm_version:
        description: 'LLVM Version'
        required: true
        default: '17.0.6'
        type: choice
        options:
          - '17.0.6'
          - '18.1.8'

env:
  LLVM_VERSION: ${{ github.event.inputs.llvm_version || '17.0.6' }}

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ninja
        run: choco install ninja -y

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Clone LLVM
        run: git clone --depth 1 --branch "llvmorg-${{ env.LLVM_VERSION }}" https://github.com/llvm/llvm-project.git

      - name: Clone OLLVM
        run: git clone --depth 1 https://github.com/DreamSoule/ollvm17.git

      - name: Copy OLLVM passes
        shell: pwsh
        run: |
          Copy-Item -Recurse "ollvm17\llvm-project\llvm\lib\Passes\Obfuscation" "llvm-project\llvm\lib\Passes\"
          Copy-Item -Force "ollvm17\llvm-project\llvm\lib\Passes\PassBuilder.cpp" "llvm-project\llvm\lib\Passes\"
          Copy-Item -Force "ollvm17\llvm-project\llvm\lib\Passes\CMakeLists.txt" "llvm-project\llvm\lib\Passes\"
          Get-ChildItem "llvm-project\llvm\lib\Passes\Obfuscation"

      - name: Configure
        run: cmake -S llvm-project/llvm -B build -G Ninja -DCMAKE_BUILD_TYPE=MinSizeRel -DLLVM_ENABLE_PROJECTS="clang;lld" -DLLVM_TARGETS_TO_BUILD="AArch64;ARM" -DLLVM_ENABLE_ASSERTIONS=OFF -DLLVM_INCLUDE_TESTS=OFF -DLLVM_INCLUDE_EXAMPLES=OFF -DLLVM_INCLUDE_BENCHMARKS=OFF -DLLVM_INCLUDE_DOCS=OFF -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl

      - name: Build
        run: cmake --build build --target clang lld llvm-ar llvm-strip -j 2

      - name: Prepare
        shell: pwsh
        run: |
          mkdir ollvm-bin
          Copy-Item build\bin\clang.exe ollvm-bin\
          Copy-Item build\bin\clang++.exe ollvm-bin\
          Copy-Item build\bin\clang-cl.exe ollvm-bin\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\lld.exe ollvm-bin\
          Copy-Item build\bin\lld-link.exe ollvm-bin\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\ld.lld.exe ollvm-bin\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\llvm-ar.exe ollvm-bin\
          Copy-Item build\bin\llvm-strip.exe ollvm-bin\

      - name: Test
        shell: pwsh
        run: |
          "int f(int x){return x>5?x*2:x+1;}" | Out-File t.c -Encoding ASCII
          .\ollvm-bin\clang.exe -target aarch64-linux-android21 -mllvm -fla -c t.c -o t.o
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "OLLVM OK"

      - name: ZIP
        shell: pwsh
        run: Compress-Archive ollvm-bin\* "OLLVM-${{ env.LLVM_VERSION }}-Windows.zip"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.LLVM_VERSION }}
          name: OLLVM ${{ env.LLVM_VERSION }}
          files: OLLVM-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
